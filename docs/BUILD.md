# Сборка desktop

Этот документ описывает **локальную сборку и установку desktop‑приложения** для разных платформ.

---

## Требования для сборки

Общие требования к окружению (Node.js 20+, pnpm) описаны в `docs/DEV-SETUP.md` в разделе «Быстрый старт».
Ниже — дополнения, специфичные именно для сборки desktop‑артефактов:

- **ОС для сборки**:
  - macOS‑артефакты надёжнее всего собирать на macOS.
  - Windows‑инсталлятор (NSIS) удобнее всего собирать на Windows.
  - Linux‑пакеты (AppImage) можно собирать на Linux.
- **Инструменты платформы**:
  - macOS: рекомендуется установленный Xcode Command Line Tools.
  - Windows: стандартной установки Node.js и инструментов от `better-sqlite3` обычно достаточно.
- **Продакшен‑релизы**:
  - для конечных пользователей рекомендуется использовать артефакты из GitHub Releases,
    которые собирает CI (см. раздел «Сборка через CI» ниже),
    а команда `pnpm run build:desktop` полезна прежде всего для локальной проверки.

## Команда

```bash
pnpm run build:desktop
```

Команда выполняет полный цикл сборки:

1. Собирает main‑часть (Electron) — компиляция TypeScript → JavaScript в `dist-electron`.
2. Собирает renderer через Vite — итоговые файлы попадают в `dist/`.
3. Вызывает `electron-builder`, который упаковывает приложение для выбранных платформ и складывает артефакты в папку `release/`.

Подробный список связанных скриптов и альтернатив (`build:electron`, `build`) смотрите в `docs/DEV-SETUP.md` в разделе «Скрипты package.json`.

## Платформы (electron-builder)

Поддерживаемые цели (см. `electron-builder.json`):

- **Windows**: NSIS installer (обычно файл вида `Log-Owl-Setup-x.y.z.exe`).
- **macOS**: DMG и ZIP (например, `Log-Owl-x.y.z.dmg`, `Log-Owl-x.y.z-mac.zip`).
- **Linux**: AppImage (например, `Log-Owl-x.y.z.AppImage`).

После успешной сборки все артефакты оказываются в каталоге `release/`.

Кратко по установке:

- **Windows**: запустите NSIS‑инсталлятор (`*.exe`) и пройдите стандартный мастер установки. Приложение обычно появится в списке установленных программ.
- **macOS**: откройте DMG, перетащите приложение в `Applications`. При первом запуске система может показать предупреждение Gatekeeper — подтвердите запуск, если доверяете источнику.
- **Linux (AppImage)**:
  - сделайте файл исполняемым: `chmod +x Log-Owl-*.AppImage`;
  - запустите файл напрямую.

Изменение набора таргетов и других настроек упаковки выполняется в `electron-builder.json`.

## Данные и обновления

- БД и app_state хранятся в **userData** (путь через `app.getPath('userData')`), не внутри папки приложения.
- При обновлении приложения (замена бинарника/установщика) каталог userData не перезаписывается — данные сохраняются.

Примерные пути `userData` по платформам:

- **Windows**: `C:\\Users\\<USERNAME>\\AppData\\Roaming\\Log Owl` (конкретный путь зависит от настроек Electron).
- **macOS**: `~/Library/Application Support/Log Owl`.
- **Linux**: `~/.config/Log Owl` (или аналогичный каталог в `$XDG_CONFIG_HOME`).

Рекомендации:

- перед ручными экспериментами с релизами делайте резервную копию каталога `userData`;
- локальные сборки и сборки, собранные через CI, используют один и тот же каталог `userData`,
  поэтому установка новой версии поверх старой **не должна приводить к потере данных**.

## Сборка через CI

Для продакшен‑релизов рекомендуется использовать GitHub Actions:

- `.github/workflows/ci.yml` — прогоняет проверки (`pnpm run check`) на pull request и push в основную ветку;
- `.github/workflows/release.yml` — собирает установщики для Windows/macOS/Linux и публикует их в GitHub Releases при пуше тега вида `v*.*.*`.

Базовый сценарий релиза:

```bash
git tag v0.1.0
git push origin v0.1.0
```

После этого GitHub Actions соберёт артефакты и прикрепит их к релизу с этим тегом — пользователи смогут скачать готовые установщики.

Локальная команда `pnpm run build:desktop` повторяет ту же цепочку сборки, что и CI, но выполняется на вашей машине.
